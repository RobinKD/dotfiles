{ config, lib, pkgs, nixosConfig, ... }:
let
  cfg = config.hm-modules.autorandr;
  ndcfg = nixosConfig.modules.desktop;
  host = nixosConfig.networking.hostName;
  edp-edid = if (host == "aquila") then
    "00ffffffffffff0009e57409000000001b1e0104a5221378070125a5534ba0270e505400000001010101010101010101010101010101403f00afa0a028503020360058c210000018000000fd0030a5f4f443010a202020202020000000fe00424f452043510a202020202020000000fe004e4531353651484d2d4e59320a01267013790000030114e5040184ff09ae002f001f009f0527000200050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001890"
  else if (host == "orion") then
    "00ffffffffffff0009e5670a000000001a1f0104a5221378070125a5534ba0270e505400000001010101010101010101010101010101ce6800caa0a0b3503020360058c210000018000000fd0c3cf086866b010a202020202020000000fe00424f452043510a202020202020000000fe004e4531353651484d2d4e5a310a0126701379000003011485a30184ff09cb002f001f009f05b2000200050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003190"
  else
    "";
in with lib; {
  options.hm-modules = { autorandr.enable = mkEnableOption "autorandr"; };

  config = mkIf cfg.enable {
    assertions = [{
      assertion = ndcfg.leftwm.enable;
      message = "Only useful with leftwm for now";
    }];

    home.file.".config/autorandr/settings.ini".text = ''
      [config]
      skip-options=crtc
    '';

    programs.autorandr = {
      enable = true;
      hooks = mkIf ndcfg.leftwm.enable {
        postswitch = { "reload-leftwm" = ''leftwm-command "SoftReload"''; };
      };
      profiles = {
        simple = {
          fingerprint = { eDP-1-1 = edp-edid; };
          config = {
            eDP-1-1 = {
              enable = true;
              mode = "1920x1080";
              position = "0x0";
              primary = true;
              rate = "165.0";
            };
          };
        };
        short-orga2 = {
          fingerprint = {
            HDMI-0 =
              "00ffffffffffff0022f01132010101011d1a0103803420782eee91a3544c99260f5054210800b30095008100d1c0a9c081c0a9408180283c80a070b023403020360006442100001a000000fd00323c1e4b11000a202020202020000000fc004850205a32346e0a2020202020000000ff00434e34363239313432430a202001d6020324f14b100403021f131211051401230907078301000068030c001000002200e2002b023a801871382d40582c450006442100001e023a80d072382d40102c458006442100001e011d007251d01e206e28550006442100001e011d00bc52d01e20b828554006442100001e000000000000000000000000000000000000009b";
            eDP-1-1 = edp-edid;
          };
          config = {
            eDP-1-1 = {
              enable = true;
              mode = "1920x1080";
              position = "0x0";
              primary = true;
              rate = "165.0";
            };
            HDMI-0 = {
              mode = "1920x1200";
              position = "1920x0";
              rate = "59.95";
            };
          };
        };
        home = {
          fingerprint = {
            DP-1-1-1 =
              "00ffffffffffff004c2d320d484b5843191f0103803c22782a5295a556549d250e5054bb8c00b30081c0810081809500a9c001010101023a801871382d40582c450056502100001e000000fd0032481e5111000a202020202020000000fc00433237463339300a2020202020000000ff0048344c523630353435380a202001ce02031af14690041f131203230907078301000066030c00100080011d00bc52d01e20b828554056502100001e8c0ad090204031200c4055005650210000188c0ad08a20e02d10103e9600565021000018000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000061";
            eDP-1-1 = edp-edid;
          };
          config = {
            eDP-1-1 = {
              enable = true;
              mode = "1920x1080";
              position = "0x0";
              primary = true;
              rate = "165.0";
            };
            DP-1-1-1 = {
              mode = "1920x1080";
              position = "1920x0";
              rate = "59.95";
            };
          };
        };
        en = {
          fingerprint = {
            HDMI-0 =
              "00ffffffffffff0026cd4866030a0000251c0103803c22782acec0a355519e270e5054a56b80710081408180a940b3009500d1c00101023a801871382d40582c450056502100001e000000ff0031313535383833373232353633000000fd00374c1e5312000a202020202020000000fc00504c5832373833480a20202020011b020322f14f90050403020111121314060715161f230907018301000065030c001000023a801871382d40582c450056502100001e011d80d0721c1620102c258056502100009e011d00bc52d01e20b828554056502100001e8c0ad090204031200c4055005650210000182a4480a0703827403020350056502100001a0000004f";
            eDP-1-1 = edp-edid;
            DP-0 =
              "00ffffffffffff0022f01132010101011d1a0103803420782eee91a3544c99260f5054210800b30095008100d1c0a9c081c0a9408180283c80a070b023403020360006442100001a000000fd00323c1e4b11000a202020202020000000fc004850205a32346e0a2020202020000000ff00434e34363239313432430a202001d6020324f14b100403021f131211051401230907078301000068030c001000002200e2002b023a801871382d40582c450006442100001e023a80d072382d40102c458006442100001e011d007251d01e206e28550006442100001e011d00bc52d01e20b828554006442100001e000000000000000000000000000000000000009b";
          };
          config = {
            eDP-1-1 = {
              enable = true;
              mode = "1920x1080";
              position = "1920x0";
              primary = true;
              rate = "165.0";
            };
            HDMI-0 = {
              mode = "1920x1080";
              position = "3840x0";
              rate = "60.0";
            };
            DP-0 = {
              mode = "1920x1080";
              position = "0x0";
              rate = "60.0";
            };
          };
        };
      };
    };
  };
}
